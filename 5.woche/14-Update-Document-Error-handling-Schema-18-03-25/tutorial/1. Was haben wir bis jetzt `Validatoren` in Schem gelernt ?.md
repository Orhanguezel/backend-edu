### **1. Was haben wir bis jetzt `Validatoren` in Schema gelernt? (Mongoose'da Åema DoÄŸrulama - Validatorler)**  

Mongoose'da **Validatoren** (doÄŸrulayÄ±cÄ±lar), bir belgeyi (document) MongoDB'ye kaydetmeden veya gÃ¼ncellemeden Ã¶nce **verilerin doÄŸruluÄŸunu kontrol eden mekanizmalardÄ±r**.  
Validatorler, **yanlÄ±ÅŸ veri eklenmesini engelleyerek veritabanÄ±nÄ±n gÃ¼venilir ve tutarlÄ± olmasÄ±nÄ± saÄŸlar**.

---

## **ğŸ“Œ 1.1. Neden `Validatoren` (DoÄŸrulayÄ±cÄ±lar) KullanÄ±rÄ±z?**
- **Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ saÄŸlar:** YanlÄ±ÅŸ veya eksik verilerin kaydedilmesini Ã¶nler.
- **Hata yÃ¶netimini kolaylaÅŸtÄ±rÄ±r:** KullanÄ±cÄ±lara hatalÄ± giriÅŸler hakkÄ±nda geri bildirim verir.
- **Ä°ÅŸ kurallarÄ±na uygunluÄŸu garantiler:** Ã–rneÄŸin, e-posta formatÄ±nÄ±n doÄŸru olmasÄ±nÄ± saÄŸlayabiliriz.
- **PerformansÄ± artÄ±rÄ±r:** Sunucu tarafÄ±nda ek doÄŸrulama yapmaya gerek kalmaz.

---

## **ğŸ“Œ 1.2. `Validatoren` TÃ¼rleri (YerleÅŸik DoÄŸrulayÄ±cÄ±lar)**  

Mongoose, ÅŸemalarda aÅŸaÄŸÄ±daki **yerleÅŸik (built-in) doÄŸrulayÄ±cÄ±larÄ±** destekler:

| **DoÄŸrulayÄ±cÄ±**  | **AÃ§Ä±klama**  | **Ã–rnek KullanÄ±m**  |
|-----------------|--------------|------------------|
| **`required`** | AlanÄ±n zorunlu olmasÄ±nÄ± saÄŸlar. | `{ name: { type: String, required: true } }` |
| **`minlength`** / **`maxlength`** | String uzunluÄŸunu sÄ±nÄ±rlar. | `{ name: { type: String, minlength: 3, maxlength: 20 } }` |
| **`min`** / **`max`** | SayÄ±sal deÄŸerleri sÄ±nÄ±rlar. | `{ age: { type: Number, min: 18, max: 65 } }` |
| **`enum`** | Sadece belirli deÄŸerleri kabul eder. | `{ category: { type: String, enum: ["food", "tech", "music"] } }` |
| **`match`** | Regex ile veri doÄŸrulama saÄŸlar. | `{ email: { type: String, match: /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/ } }` |

### **ğŸ“Œ Ã–rnek Åema KullanÄ±mÄ±**
AÅŸaÄŸÄ±daki **User ÅŸemasÄ±**, farklÄ± doÄŸrulayÄ±cÄ±larÄ± iÃ§ermektedir:
```js
import { Schema, model } from "mongoose";

const userSchema = new Schema({
  firstName: { type: String, required: true, minlength: 3 },  // Zorunlu, min 3 karakter
  lastName: { type: String, required: true, minlength: 3 },   // Zorunlu, min 3 karakter
  age: { type: Number, min: 18, max: 65 },                    // 18-65 yaÅŸ sÄ±nÄ±rÄ±
  email: { 
    type: String, 
    required: true, 
    match: /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/  // E-posta formatÄ± doÄŸrulamasÄ±
  },
  role: { type: String, enum: ["admin", "user", "moderator"] } // Sadece belirli roller
});

export const User = model("User", userSchema);
```

âœ… **Bu yapÄ± sayesinde:**  
- `firstName` **boÅŸ olamaz ve en az 3 karakter olmalÄ±dÄ±r.**  
- `age` **18 ile 65 arasÄ±nda olmalÄ±dÄ±r.**  
- `email` **geÃ§erli bir formatta olmalÄ±dÄ±r (`name@example.com`).**  
- `role` **sadece `admin`, `user` veya `moderator` olabilir.**

---

## **ğŸ“Œ 1.3. `Custom Validatoren` (Ã–zel DoÄŸrulayÄ±cÄ±lar)**
Mongoose, **Ã¶zel doÄŸrulayÄ±cÄ±lar (custom validators)** tanÄ±mlamamÄ±za da izin verir.  
Bu, **karmaÅŸÄ±k iÅŸ kurallarÄ±nÄ± uygulamak iÃ§in kullanÄ±lÄ±r**.

### **ğŸ“Œ Ã–rnek: Parola En Az 1 BÃ¼yÃ¼k Harf ve 1 Rakam Ä°Ã§ermeli**
```js
const userSchema = new Schema({
  password: {
    type: String,
    required: true,
    validate: {
      validator: function (v) {
        return /^(?=.*[A-Z])(?=.*\d).{8,}$/.test(v);
      },
      message: "Das Passwort muss mindestens 8 Zeichen lang sein, einen GroÃŸbuchstaben und eine Zahl enthalten."
    }
  }
});
```
âœ… **Bu Ã¶zel doÄŸrulayÄ±cÄ± ÅŸunu saÄŸlar:**  
- Parola **en az 8 karakter uzunluÄŸunda olmalÄ±dÄ±r.**  
- **En az bir bÃ¼yÃ¼k harf (`A-Z`) iÃ§ermelidir.**  
- **En az bir rakam (`0-9`) iÃ§ermelidir.**  

---

## **ğŸ“Œ 1.4. `runValidators` SeÃ§eneÄŸi ile GÃ¼ncelleme SÄ±rasÄ±nda DoÄŸrulama**
Mongooseâ€™da **`update` iÅŸlemlerinde doÄŸrulamalar (`validators`) varsayÄ±lan olarak Ã§alÄ±ÅŸmaz!**  
Bunu **`runValidators: true`** ayarÄ± ile etkinleÅŸtirmeliyiz.

**Ã–rnek:**  
```js
await User.findByIdAndUpdate(userId, { age: 70 }, { runValidators: true });
```
ğŸ’¡ **Bu sayede `age: 70` olduÄŸu iÃ§in `max: 65` kÄ±sÄ±tlamasÄ±na takÄ±lacaktÄ±r ve hata dÃ¶necektir.**  

---

## **ğŸ“Œ 1.5. `async` Ã–zel DoÄŸrulayÄ±cÄ± KullanÄ±mÄ± (VeritabanÄ± KontrolÃ¼)**
EÄŸer doÄŸrulayÄ±cÄ±nÄ±n **veritabanÄ±nda baÅŸka bir kaydÄ± kontrol etmesi gerekiyorsa**, **`async` Ã¶zel doÄŸrulayÄ±cÄ±** kullanabiliriz.

### **ğŸ“Œ Ã–rnek: `email` daha Ã¶nce kullanÄ±lmÄ±ÅŸ mÄ±?**
```js
const userSchema = new Schema({
  email: {
    type: String,
    required: true,
    unique: true,
    validate: {
      validator: async function (email) {
        const existingUser = await User.findOne({ email });
        return !existingUser; // EÄŸer email zaten varsa false dÃ¶necek
      },
      message: "Diese E-Mail-Adresse ist bereits registriert!"
    }
  }
});
```
âœ… **Bu kod sayesinde:**  
- **KayÄ±t sÄ±rasÄ±nda eÄŸer `email` veritabanÄ±nda varsa hata dÃ¶ndÃ¼rÃ¼lÃ¼r.**  
- **Yeni bir kullanÄ±cÄ± aynÄ± `email` ile kaydedilemez.**  

---

## **ğŸ“Œ 1.6. Hata YÃ¶netimi (Error Handling)**
EÄŸer bir `ValidatorError` oluÅŸursa, hatayÄ± `catch` bloÄŸunda yakalayabiliriz:

```js
const addUser = async (req, res) => {
  try {
    const newUser = new User(req.body);
    await newUser.save();
    res.json({ msg: "Benutzer erfolgreich hinzugefÃ¼gt!", newUser });
  } catch (error) {
    if (error.name === "ValidationError") {
      res.status(400).json({ msg: "Validierungsfehler!", errors: error.errors });
    } else {
      res.status(500).json({ msg: "Interner Serverfehler!", error });
    }
  }
};
```
âœ… **Bu sayede hata mesajlarÄ± API tarafÄ±ndan dÃ¼zgÃ¼n bir ÅŸekilde dÃ¶ndÃ¼rÃ¼lecektir.**

---

## **ğŸ“Œ 1.7. `Validatoren` Kullanarak Hata Testi**
Hata durumlarÄ±nÄ± test etmek iÃ§in **geÃ§ersiz veri gÃ¶nderebiliriz**.

ğŸ’¡ **Ã–rnek: GeÃ§ersiz KullanÄ±cÄ± Ekleme (`POST /users`)**
```json
{
  "firstName": "Jo",
  "lastName": "",
  "age": 17,
  "email": "invalidemail",
  "role": "hacker"
}
```
ğŸ’¥ **Hata dÃ¶necektir:**
```json
{
  "msg": "Validierungsfehler!",
  "errors": {
    "firstName": { "message": "Der Name muss mindestens 3 Zeichen haben." },
    "lastName": { "message": "Nachname ist erforderlich." },
    "age": { "message": "Alter muss mindestens 18 sein." },
    "email": { "message": "UngÃ¼ltiges E-Mail-Format." },
    "role": { "message": "`hacker` ist kein gÃ¼ltiger Wert fÃ¼r `role`." }
  }
}
```
âœ… **BÃ¶ylece kullanÄ±cÄ±ya anlaÅŸÄ±lÄ±r hata mesajlarÄ± dÃ¶nebiliriz.**  

---

## **ğŸ“Œ 1.8. SonuÃ§**
ğŸ¯ **Mongoose `Validatoren` kullanÄ±mÄ± ile:**  
âœ” **Veri doÄŸruluÄŸunu saÄŸlarÄ±z.**  
âœ” **Eksik veya hatalÄ± verileri engelleriz.**  
âœ” **Sunucu tarafÄ±nda ekstra kontrolleri azaltÄ±rÄ±z.**  
âœ” **Daha gÃ¼venilir ve hatasÄ±z bir API oluÅŸtururuz.** ğŸš€